// CS2 Button States Controller - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ JSON —Å–æ—Å—Ç–æ—è–Ω–∏—è
class ButtonStatesController {
    constructor() {
        this.apiUrl = 'https://pleshalive.github.io/cs2-remote-control/api/global';
        this.gistId = 'b4f8c2d6e1a9f5d3c8b7e6a4d2f1c3e5'; // –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        this.gistUrl = `https://api.github.com/gists/${this.gistId}`;
        
        this.totalPresses = 0;
        this.currentStates = {};
        
        // UI —ç–ª–µ–º–µ–Ω—Ç—ã
        this.logElement = document.getElementById('event-log');
        this.activeCountElement = document.getElementById('active-count');
        this.totalPressesElement = document.getElementById('total-presses');
        this.lastUpdateElement = document.getElementById('last-update');
        
        this.init();
    }

    init() {
        this.bindEvents();
        this.loadCurrentStates();
        this.startStateMonitoring();
        
        this.log('üéõÔ∏è Button States Controller –∑–∞–ø—É—â–µ–Ω', 'success');
        this.log(`üì° –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ API: ${this.apiUrl}`, 'info');
    }

    bindEvents() {
        // –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        document.querySelectorAll('.control-btn').forEach(button => {
            button.addEventListener('click', (e) => this.handleButtonClick(e));
        });

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–≥–æ–º
        document.getElementById('clear-log').addEventListener('click', () => {
            this.logElement.innerHTML = '<div class="log-entry info">–õ–æ–≥ –æ—á–∏—â–µ–Ω</div>';
        });

        document.getElementById('refresh-states').addEventListener('click', () => {
            this.loadCurrentStates();
        });
    }

    async handleButtonClick(event) {
        const button = event.target.closest('.control-btn');
        const buttonName = button.dataset.button;
        
        // –í–∏–∑—É–∞–ª—å–Ω–∞—è –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å
        button.classList.add('pressed-state');
        button.disabled = true;
        
        setTimeout(() => {
            button.classList.remove('pressed-state');
            button.disabled = false;
        }, 2000);

        try {
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ –Ω–∞ 2 —Å–µ–∫—É–Ω–¥—ã
            await this.activateButton(buttonName);
            
            this.totalPresses++;
            this.totalPressesElement.textContent = this.totalPresses;
            
            this.log(`üéØ –ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞: ${buttonName} (+)`, 'success');
            
            // –ß–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º
            setTimeout(() => {
                this.deactivateButton(buttonName);
                this.log(`‚èπÔ∏è –ö–Ω–æ–ø–∫–∞ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞: ${buttonName} (-)`, 'info');
            }, 2000);
            
        } catch (error) {
            this.log(`‚ùå –û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫–Ω–æ–ø–∫–∏: ${error.message}`, 'error');
            button.disabled = false;
        }
    }

    async activateButton(buttonName) {
        try {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            this.currentStates[buttonName] = {
                state: '+',
                timestamp: Date.now()
            };
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            this.updateButtonUI(buttonName, '+');
            
            // –ü—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ GitHub Gist
            await this.updateGistStates();
            
        } catch (error) {
            // Fallback: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            this.saveToLocalStorage();
            console.warn('–ò—Å–ø–æ–ª—å–∑—É–µ–º localStorage fallback:', error);
        }
    }

    async deactivateButton(buttonName) {
        try {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            this.currentStates[buttonName] = {
                state: '-',
                timestamp: Date.now()
            };
            
            // –û–±–Ω–æ–≤–ª—è–µ–º UI
            this.updateButtonUI(buttonName, '-');
            
            // –ü—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ GitHub Gist
            await this.updateGistStates();
            
        } catch (error) {
            // Fallback: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            this.saveToLocalStorage();
            console.warn('–ò—Å–ø–æ–ª—å–∑—É–µ–º localStorage fallback:', error);
        }
    }

    updateButtonUI(buttonName, state) {
        const stateElement = document.querySelector(`[data-state="${buttonName}"]`);
        if (stateElement) {
            stateElement.textContent = state;
            stateElement.className = `button-state ${state === '+' ? 'active' : 'inactive'}`;
        }
        
        this.updateActiveCount();
    }

    updateActiveCount() {
        const activeCount = Object.values(this.currentStates).filter(s => s.state === '+').length;
        this.activeCountElement.textContent = activeCount;
    }

    async updateGistStates() {
        // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è API
        const apiData = {
            lastUpdate: Date.now(),
            buttons: {}
        };

        // –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫ —Å –∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏
        const buttonConfigs = {
            live: { page: 1, row: 2, col: 1, label: "LIVE" },
            pause: { page: 1, row: 2, col: 2, label: "PAUSE" },
            stop: { page: 1, row: 2, col: 3, label: "STOP" },
            round1: { page: 1, row: 3, col: 1, label: "Round 1" },
            round2: { page: 1, row: 3, col: 2, label: "Round 2" },
            round3: { page: 1, row: 3, col: 3, label: "Round 3" },
            round4: { page: 1, row: 3, col: 4, label: "Round 4" },
            round5: { page: 1, row: 3, col: 5, label: "Round 5" },
            round6: { page: 1, row: 3, col: 6, label: "Round 6" },
            round7: { page: 1, row: 3, col: 7, label: "Round 7" },
            round8: { page: 1, row: 4, col: 1, label: "Round 8" },
            round9: { page: 1, row: 4, col: 2, label: "Round 9" },
            round10: { page: 1, row: 4, col: 3, label: "Round 10" }
        };

        // –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–Ω–æ–ø–æ–∫
        for (const [buttonName, config] of Object.entries(buttonConfigs)) {
            const currentState = this.currentStates[buttonName] || { state: '-', timestamp: 0 };
            
            apiData.buttons[buttonName] = {
                state: currentState.state,
                timestamp: currentState.timestamp,
                page: config.page,
                row: config.row,
                col: config.col,
                label: config.label
            };
        }

        // –ü—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —á–µ—Ä–µ–∑ GitHub Gist
        const gistData = {
            description: "CS2 Button States - Real-time button control",
            public: true,
            files: {
                "button-states.json": {
                    content: JSON.stringify(apiData, null, 2)
                },
                "global": {
                    content: JSON.stringify({
                        ...apiData,
                        info: "CS2 Button States - GitHub Pages Static API",
                        note: "State '+' means button pressed (2 sec), '-' means idle"
                    }, null, 2)
                }
            }
        };

        try {
            const response = await fetch(this.gistUrl, {
                method: 'PATCH',
                headers: {
                    'Accept': 'application/vnd.github.v3+json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(gistData)
            });

            if (!response.ok) {
                // –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å, –ø—Ä–æ–±—É–µ–º —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π
                const createResponse = await fetch('https://api.github.com/gists', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(gistData)
                });
                
                if (createResponse.ok) {
                    const newGist = await createResponse.json();
                    this.gistId = newGist.id;
                    this.gistUrl = `https://api.github.com/gists/${this.gistId}`;
                    this.log(`üìù –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π Gist: ${this.gistId}`, 'success');
                }
            }
            
        } catch (error) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback
            throw new Error(`GitHub API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: ${error.message}`);
        }
    }

    async loadCurrentStates() {
        try {
            const response = await fetch(this.apiUrl + '?t=' + Date.now());
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.buttons) {
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                    for (const [buttonName, buttonData] of Object.entries(data.buttons)) {
                        this.currentStates[buttonName] = {
                            state: buttonData.state,
                            timestamp: buttonData.timestamp
                        };
                        
                        this.updateButtonUI(buttonName, buttonData.state);
                    }
                    
                    this.lastUpdateElement.textContent = new Date(data.lastUpdate || Date.now()).toLocaleTimeString();
                    this.log('‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ API', 'success');
                }
            }
        } catch (error) {
            this.log(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è: ${error.message}`, 'warning');
            this.loadFromLocalStorage();
        }
    }

    saveToLocalStorage() {
        localStorage.setItem('cs2-button-states', JSON.stringify(this.currentStates));
    }

    loadFromLocalStorage() {
        const saved = localStorage.getItem('cs2-button-states');
        if (saved) {
            this.currentStates = JSON.parse(saved);
            
            for (const [buttonName, state] of Object.entries(this.currentStates)) {
                this.updateButtonUI(buttonName, state.state);
            }
            
            this.log('üì¶ –°–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ localStorage', 'info');
        }
    }

    startStateMonitoring() {
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
        setInterval(() => {
            this.loadCurrentStates();
        }, 5000);

        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º —Å—Ç–∞—Ä—ã–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
        setInterval(() => {
            const now = Date.now();
            let updated = false;
            
            for (const [buttonName, state] of Object.entries(this.currentStates)) {
                if (state.state === '+' && now - state.timestamp > 2000) {
                    this.currentStates[buttonName] = {
                        state: '-',
                        timestamp: now
                    };
                    this.updateButtonUI(buttonName, '-');
                    updated = true;
                }
            }
            
            if (updated) {
                this.updateGistStates().catch(e => {
                    this.saveToLocalStorage();
                });
            }
        }, 1000);
    }

    log(message, type = 'info') {
        const timestamp = new Date().toLocaleTimeString();
        const logEntry = document.createElement('div');
        logEntry.className = `log-entry ${type}`;
        logEntry.textContent = `[${timestamp}] ${message}`;
        
        this.logElement.appendChild(logEntry);
        this.logElement.scrollTop = this.logElement.scrollHeight;

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
        const entries = this.logElement.children;
        if (entries.length > 50) {
            this.logElement.removeChild(entries[0]);
        }
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
let app;

document.addEventListener('DOMContentLoaded', () => {
    app = new ButtonStatesController();
});
